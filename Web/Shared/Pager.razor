@using Microsoft.Extensions.Localization
@inject IStringLocalizer<App> L

<div class="d-flex flex-row align-center justify-center gap-1 mt-3 flex-wrap">

    <MudButton Size="Size.Small" Variant="Variant.Outlined"
               Disabled="@(!CanGoPrev)"
               OnClick="@(() => GoTo(CurrentPage - 1))">
        @L["Pager_Previous"]
    </MudButton>

    @foreach (var link in Links)
    {
        if (link.IsEllipsis)
        {
            <MudText class="px-2">…</MudText>
        }
        else
        {
            <MudButton Size="Size.Small"
                       Variant="@(link.Active ? Variant.Filled : Variant.Outlined)"
                       Color="@(link.Active ? Color.Primary : Color.Default)"
                       Disabled="@(!link.Enabled)"
                       OnClick="@(() => GoTo(link.Page))">
                @link.Text
            </MudButton>
        }
    }

    <MudButton Size="Size.Small" Variant="Variant.Outlined"
               Disabled="@(!CanGoNext)"
               OnClick="@(() => GoTo(CurrentPage + 1))">
        @L["Pager_Next"]
    </MudButton>

</div>

@code {
    [Parameter] public int TotalItems { get; set; }
    [Parameter] public int PageSize { get; set; } = 12;
    [Parameter] public int Radius { get; set; } = 2;

    [Parameter] public int CurrentPage { get; set; } = 1;
    [Parameter] public EventCallback<int> CurrentPageChanged { get; set; }
    [Parameter] public EventCallback OnChanged { get; set; }

    private int TotalPages => Math.Max(1, (int)Math.Ceiling((double)TotalItems / Math.Max(1, PageSize)));
    private bool CanGoPrev => CurrentPage > 1;
    private bool CanGoNext => CurrentPage < TotalPages;

    private record Link(string Text, int Page, bool Enabled = true, bool Active = false, bool IsEllipsis = false);
    private List<Link> Links = new();

    protected override void OnParametersSet()
    {
        if (CurrentPage < 1) CurrentPage = 1;
        if (CurrentPage > TotalPages) CurrentPage = TotalPages;
        BuildLinks();
    }

    private void BuildLinks()
    {
        Links.Clear();
        var start = Math.Max(1, CurrentPage - Radius);
        var end = Math.Min(TotalPages, CurrentPage + Radius);

        if (start > 1)
        {
            Links.Add(new Link("1", 1));
            if (start > 2) Links.Add(new Link("…", CurrentPage, true, false, true));
        }

        for (int i = start; i <= end; i++)
            Links.Add(new Link(i.ToString(), i, true, i == CurrentPage));

        if (end < TotalPages)
        {
            if (end < TotalPages - 1) Links.Add(new Link("…", CurrentPage, true, false, true));
            Links.Add(new Link(TotalPages.ToString(), TotalPages));
        }
    }

    private async Task GoTo(int page)
    {
        if (page == CurrentPage || page < 1 || page > TotalPages) return;
        CurrentPage = page;
        BuildLinks();
        await CurrentPageChanged.InvokeAsync(CurrentPage);
        await OnChanged.InvokeAsync();
    }
}

@*
 Qué hacemos:
  - Implementamos un **paginador** reutilizable con enlaces numéricos, elipsis y botones Anterior/Siguiente,
    con textos localizados.

 Parámetros:
  - TotalItems (int): total de elementos a paginar.
  - PageSize (int=12): elementos por página.
  - Radius (int=2): cuántas páginas mostramos alrededor de la actual.
  - CurrentPage (int=1): página activa (soporta two-way bind con @bind-CurrentPage).
  - CurrentPageChanged (EventCallback<int>): se dispara al cambiar de página.
  - OnChanged (EventCallback): callback adicional tras el cambio (útil para recargar datos).

 Lógica:
  - Calculamos TotalPages = ceil(TotalItems / PageSize) y **acotamos** CurrentPage al rango [1..TotalPages].
  - BuildLinks() genera:
      • Primera página si no está en el rango visible.
      • Elipsis cuando hay huecos.
      • Ventana [CurrentPage-Radius .. CurrentPage+Radius].
      • Última página si procede.
  - GoTo(page) actualiza CurrentPage, reconstruye enlaces y lanza CurrentPageChanged + OnChanged.

 UI:
  - Botones Anterior/Siguiente (deshabilitados en extremos).
  - Botones numéricos; la página activa usa `Variant.Filled` y `Color.Primary`.
  - Elipsis renderizada como MudText (“…”).
  - Textos “Anterior/Siguiente” localizados con `IStringLocalizer<App>`.

 Notas:
  - Si PageSize < 1 lo normalizamos a 1 para evitar divisiones por cero.
  - Ideal para listas con paginación en servidor: en OnChanged podemos invocar el fetch de la página.
*@
